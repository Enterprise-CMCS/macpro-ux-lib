{"version":3,"file":"FileInput-FileInput-stories.ab35be24.iframe.bundle.js","mappings":";;AAyQA;AAGA","sources":["webpack://@enterprise-cmcs/macpro-ux-lib/./node_modules/@uswds/uswds/packages/usa-file-input/src/index.js"],"sourcesContent":["const selectOrMatches = require(\"../../uswds-core/src/js/utils/select-or-matches\");\nconst behavior = require(\"../../uswds-core/src/js/utils/behavior\");\nconst Sanitizer = require(\"../../uswds-core/src/js/utils/sanitizer\");\nconst { prefix: PREFIX } = require(\"../../uswds-core/src/js/config\");\n\nconst DROPZONE_CLASS = `${PREFIX}-file-input`;\nconst DROPZONE = `.${DROPZONE_CLASS}`;\nconst INPUT_CLASS = `${PREFIX}-file-input__input`;\nconst TARGET_CLASS = `${PREFIX}-file-input__target`;\nconst INPUT = `.${INPUT_CLASS}`;\nconst BOX_CLASS = `${PREFIX}-file-input__box`;\nconst INSTRUCTIONS_CLASS = `${PREFIX}-file-input__instructions`;\nconst PREVIEW_CLASS = `${PREFIX}-file-input__preview`;\nconst PREVIEW_HEADING_CLASS = `${PREFIX}-file-input__preview-heading`;\nconst DISABLED_CLASS = `${PREFIX}-file-input--disabled`;\nconst CHOOSE_CLASS = `${PREFIX}-file-input__choose`;\nconst ACCEPTED_FILE_MESSAGE_CLASS = `${PREFIX}-file-input__accepted-files-message`;\nconst DRAG_TEXT_CLASS = `${PREFIX}-file-input__drag-text`;\nconst DRAG_CLASS = `${PREFIX}-file-input--drag`;\nconst LOADING_CLASS = \"is-loading\";\nconst HIDDEN_CLASS = \"display-none\";\nconst INVALID_FILE_CLASS = \"has-invalid-file\";\nconst GENERIC_PREVIEW_CLASS_NAME = `${PREFIX}-file-input__preview-image`;\nconst GENERIC_PREVIEW_CLASS = `${GENERIC_PREVIEW_CLASS_NAME}--generic`;\nconst PDF_PREVIEW_CLASS = `${GENERIC_PREVIEW_CLASS_NAME}--pdf`;\nconst WORD_PREVIEW_CLASS = `${GENERIC_PREVIEW_CLASS_NAME}--word`;\nconst VIDEO_PREVIEW_CLASS = `${GENERIC_PREVIEW_CLASS_NAME}--video`;\nconst EXCEL_PREVIEW_CLASS = `${GENERIC_PREVIEW_CLASS_NAME}--excel`;\nconst SPACER_GIF =\n  \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\n\nlet TYPE_IS_VALID = Boolean(true); // logic gate for change listener\n\n/**\n * The properties and elements within the file input.\n * @typedef {Object} FileInputContext\n * @property {HTMLDivElement} dropZoneEl\n * @property {HTMLInputElement} inputEl\n */\n\n/**\n * Get an object of the properties and elements belonging directly to the given\n * file input component.\n *\n * @param {HTMLElement} el the element within the file input\n * @returns {FileInputContext} elements\n */\nconst getFileInputContext = (el) => {\n  const dropZoneEl = el.closest(DROPZONE);\n\n  if (!dropZoneEl) {\n    throw new Error(`Element is missing outer ${DROPZONE}`);\n  }\n\n  const inputEl = dropZoneEl.querySelector(INPUT);\n\n  return {\n    dropZoneEl,\n    inputEl,\n  };\n};\n\n/**\n * Disable the file input component\n *\n * @param {HTMLElement} el An element within the file input component\n */\nconst disable = (el) => {\n  const { dropZoneEl, inputEl } = getFileInputContext(el);\n\n  inputEl.disabled = true;\n  dropZoneEl.classList.add(DISABLED_CLASS);\n  dropZoneEl.setAttribute(\"aria-disabled\", \"true\");\n};\n\n/**\n * Enable the file input component\n *\n * @param {HTMLElement} el An element within the file input component\n */\nconst enable = (el) => {\n  const { dropZoneEl, inputEl } = getFileInputContext(el);\n\n  inputEl.disabled = false;\n  dropZoneEl.classList.remove(DISABLED_CLASS);\n  dropZoneEl.removeAttribute(\"aria-disabled\");\n};\n\n/**\n *\n * @param {String} s special characters\n * @returns {String} replaces specified values\n */\nconst replaceName = (s) => {\n  const c = s.charCodeAt(0);\n  if (c === 32) return \"-\";\n  if (c >= 65 && c <= 90) return `img_${s.toLowerCase()}`;\n  return `__${(\"000\", c.toString(16)).slice(-4)}`;\n};\n\n/**\n * Creates an ID name for each file that strips all invalid characters.\n * @param {String} name - name of the file added to file input (searchvalue)\n * @returns {String} same characters as the name with invalid chars removed (newvalue)\n */\nconst makeSafeForID = (name) => name.replace(/[^a-z0-9]/g, replaceName);\n\n// Takes a generated safe ID and creates a unique ID.\nconst createUniqueID = (name) =>\n  `${name}-${Math.floor(Date.now().toString() / 1000)}`;\n\n/**\n * Builds full file input component\n * @param {HTMLElement} fileInputEl - original file input on page\n * @returns {HTMLElement|HTMLElement} - Instructions, target area div\n */\nconst buildFileInput = (fileInputEl) => {\n  const acceptsMultiple = fileInputEl.hasAttribute(\"multiple\");\n  const fileInputParent = document.createElement(\"div\");\n  const dropTarget = document.createElement(\"div\");\n  const box = document.createElement(\"div\");\n  const instructions = document.createElement(\"div\");\n  const disabled = fileInputEl.hasAttribute(\"disabled\");\n  let defaultAriaLabel;\n\n  // Adds class names and other attributes\n  fileInputEl.classList.remove(DROPZONE_CLASS);\n  fileInputEl.classList.add(INPUT_CLASS);\n  fileInputParent.classList.add(DROPZONE_CLASS);\n  box.classList.add(BOX_CLASS);\n  instructions.classList.add(INSTRUCTIONS_CLASS);\n  instructions.setAttribute(\"aria-hidden\", \"true\");\n  dropTarget.classList.add(TARGET_CLASS);\n  // Encourage screenreader to read out aria changes immediately following upload status change\n  fileInputEl.setAttribute(\"aria-live\", \"polite\");\n\n  // Adds child elements to the DOM\n  fileInputEl.parentNode.insertBefore(dropTarget, fileInputEl);\n  fileInputEl.parentNode.insertBefore(fileInputParent, dropTarget);\n  dropTarget.appendChild(fileInputEl);\n  fileInputParent.appendChild(dropTarget);\n  fileInputEl.parentNode.insertBefore(instructions, fileInputEl);\n  fileInputEl.parentNode.insertBefore(box, fileInputEl);\n\n  // Disabled styling\n  if (disabled) {\n    disable(fileInputEl);\n  }\n\n  // Sets instruction test and aria-label based on whether or not multiple files are accepted\n  if (acceptsMultiple) {\n    defaultAriaLabel = \"No files selected\";\n    instructions.innerHTML = Sanitizer.escapeHTML`<span class=\"${DRAG_TEXT_CLASS}\">Drag files here or </span><span class=\"${CHOOSE_CLASS}\">choose from folder</span>`;\n    fileInputEl.setAttribute(\"aria-label\", defaultAriaLabel);\n    fileInputEl.setAttribute(\"data-default-aria-label\", defaultAriaLabel);\n  } else {\n    defaultAriaLabel = \"No file selected\";\n    instructions.innerHTML = Sanitizer.escapeHTML`<span class=\"${DRAG_TEXT_CLASS}\">Drag file here or </span><span class=\"${CHOOSE_CLASS}\">choose from folder</span>`;\n    fileInputEl.setAttribute(\"aria-label\", defaultAriaLabel);\n    fileInputEl.setAttribute(\"data-default-aria-label\", defaultAriaLabel);\n  }\n\n  // IE11 and Edge do not support drop files on file inputs, so we've removed text that indicates that\n  if (\n    /rv:11.0/i.test(navigator.userAgent) ||\n    /Edge\\/\\d./i.test(navigator.userAgent)\n  ) {\n    fileInputParent.querySelector(`.${DRAG_TEXT_CLASS}`).outerHTML = \"\";\n  }\n\n  return { instructions, dropTarget };\n};\n\n/**\n * Removes image previews, we want to start with a clean list every time files are added to the file input\n * @param {HTMLElement} dropTarget - target area div that encases the input\n * @param {HTMLElement} instructions - text to inform users to drag or select files\n */\nconst removeOldPreviews = (dropTarget, instructions, inputAriaLabel) => {\n  const filePreviews = dropTarget.querySelectorAll(`.${PREVIEW_CLASS}`);\n  const fileInputElement = dropTarget.querySelector(INPUT);\n  const currentPreviewHeading = dropTarget.querySelector(\n    `.${PREVIEW_HEADING_CLASS}`\n  );\n  const currentErrorMessage = dropTarget.querySelector(\n    `.${ACCEPTED_FILE_MESSAGE_CLASS}`\n  );\n\n  /**\n   * finds the parent of the passed node and removes the child\n   * @param {HTMLElement} node\n   */\n  const removeImages = (node) => {\n    node.parentNode.removeChild(node);\n  };\n\n  // Remove the heading above the previews\n  if (currentPreviewHeading) {\n    currentPreviewHeading.outerHTML = \"\";\n  }\n\n  // Remove existing error messages\n  if (currentErrorMessage) {\n    currentErrorMessage.outerHTML = \"\";\n    dropTarget.classList.remove(INVALID_FILE_CLASS);\n  }\n\n  // Get rid of existing previews if they exist, show instructions\n  if (filePreviews !== null) {\n    if (instructions) {\n      instructions.classList.remove(HIDDEN_CLASS);\n    }\n    fileInputElement.setAttribute(\"aria-label\", inputAriaLabel);\n    Array.prototype.forEach.call(filePreviews, removeImages);\n  }\n};\n\n/**\n * When new files are applied to file input, this function generates previews\n * and removes old ones.\n * @param {event} e\n * @param {HTMLElement} fileInputEl - file input element\n * @param {HTMLElement} instructions - text to inform users to drag or select files\n * @param {HTMLElement} dropTarget - target area div that encases the input\n */\n\nconst handleChange = (e, fileInputEl, instructions, dropTarget) => {\n  const fileNames = e.target.files;\n  const filePreviewsHeading = document.createElement(\"div\");\n  const inputAriaLabel = fileInputEl.dataset.defaultAriaLabel;\n  const fileStore = [];\n\n  // First, get rid of existing previews\n  removeOldPreviews(dropTarget, instructions, inputAriaLabel);\n\n  // Then, iterate through files list and:\n  // 1. Add selected file list names to aria-label\n  // 2. Create previews\n  for (let i = 0; i < fileNames.length; i += 1) {\n    const reader = new FileReader();\n    const fileName = fileNames[i].name;\n\n    // Push updated file names into the store array\n    fileStore.push(fileName);\n\n    // read out the store array via aria-label, wording options vary based on file count\n    if (i === 0) {\n      fileInputEl.setAttribute(\n        \"aria-label\",\n        `You have selected the file: ${fileName}`\n      );\n    } else if (i >= 1) {\n      fileInputEl.setAttribute(\n        \"aria-label\",\n        `You have selected ${fileNames.length} files: ${fileStore.join(\", \")}`\n      );\n    }\n\n    // Starts with a loading image while preview is created\n    reader.onloadstart = function createLoadingImage() {\n      const imageId = createUniqueID(makeSafeForID(fileName));\n\n      instructions.insertAdjacentHTML(\n        \"afterend\",\n        Sanitizer.escapeHTML`<div class=\"${PREVIEW_CLASS}\" aria-hidden=\"true\">\n          <img id=\"${imageId}\" src=\"${SPACER_GIF}\" alt=\"\" class=\"${GENERIC_PREVIEW_CLASS_NAME} ${LOADING_CLASS}\"/>${fileName}\n        <div>`\n      );\n    };\n\n    // Not all files will be able to generate previews. In case this happens, we provide several types \"generic previews\" based on the file extension.\n    reader.onloadend = function createFilePreview() {\n      const imageId = createUniqueID(makeSafeForID(fileName));\n      const previewImage = document.getElementById(imageId);\n      if (fileName.indexOf(\".pdf\") > 0) {\n        previewImage.setAttribute(\n          \"onerror\",\n          `this.onerror=null;this.src=\"${SPACER_GIF}\"; this.classList.add(\"${PDF_PREVIEW_CLASS}\")`\n        );\n      } else if (\n        fileName.indexOf(\".doc\") > 0 ||\n        fileName.indexOf(\".pages\") > 0\n      ) {\n        previewImage.setAttribute(\n          \"onerror\",\n          `this.onerror=null;this.src=\"${SPACER_GIF}\"; this.classList.add(\"${WORD_PREVIEW_CLASS}\")`\n        );\n      } else if (\n        fileName.indexOf(\".xls\") > 0 ||\n        fileName.indexOf(\".numbers\") > 0\n      ) {\n        previewImage.setAttribute(\n          \"onerror\",\n          `this.onerror=null;this.src=\"${SPACER_GIF}\"; this.classList.add(\"${EXCEL_PREVIEW_CLASS}\")`\n        );\n      } else if (fileName.indexOf(\".mov\") > 0 || fileName.indexOf(\".mp4\") > 0) {\n        previewImage.setAttribute(\n          \"onerror\",\n          `this.onerror=null;this.src=\"${SPACER_GIF}\"; this.classList.add(\"${VIDEO_PREVIEW_CLASS}\")`\n        );\n      } else {\n        previewImage.setAttribute(\n          \"onerror\",\n          `this.onerror=null;this.src=\"${SPACER_GIF}\"; this.classList.add(\"${GENERIC_PREVIEW_CLASS}\")`\n        );\n      }\n\n      // Removes loader and displays preview\n      previewImage.classList.remove(LOADING_CLASS);\n      previewImage.src = reader.result;\n    };\n\n    if (fileNames[i]) {\n      reader.readAsDataURL(fileNames[i]);\n    }\n\n    // Adds heading above file previews, pluralizes if there are multiple\n    if (i === 0) {\n      dropTarget.insertBefore(filePreviewsHeading, instructions);\n      filePreviewsHeading.innerHTML = `Selected file <span class=\"usa-file-input__choose\">Change file</span>`;\n    } else if (i >= 1) {\n      dropTarget.insertBefore(filePreviewsHeading, instructions);\n      filePreviewsHeading.innerHTML = Sanitizer.escapeHTML`${\n        i + 1\n      } files selected <span class=\"usa-file-input__choose\">Change files</span>`;\n    }\n\n    // Hides null state content and sets preview heading class\n    if (filePreviewsHeading) {\n      instructions.classList.add(HIDDEN_CLASS);\n      filePreviewsHeading.classList.add(PREVIEW_HEADING_CLASS);\n    }\n  }\n};\n\n/**\n * When using an Accept attribute, invalid files will be hidden from\n * file browser, but they can still be dragged to the input. This\n * function prevents them from being dragged and removes error states\n * when correct files are added.\n * @param {event} e\n * @param {HTMLElement} fileInputEl - file input element\n * @param {HTMLElement} instructions - text to inform users to drag or select files\n * @param {HTMLElement} dropTarget - target area div that encases the input\n */\nconst preventInvalidFiles = (e, fileInputEl, instructions, dropTarget) => {\n  const acceptedFilesAttr = fileInputEl.getAttribute(\"accept\");\n  dropTarget.classList.remove(INVALID_FILE_CLASS);\n\n  /**\n   * We can probably move away from this once IE11 support stops, and replace\n   * with a simple es `.includes`\n   * check if element is in array\n   * check if 1 or more alphabets are in string\n   * if element is present return the position value and -1 otherwise\n   * @param {Object} file\n   * @param {String} value\n   * @returns {Boolean}\n   */\n  const isIncluded = (file, value) => {\n    let returnValue = false;\n    const pos = file.indexOf(value);\n    if (pos >= 0) {\n      returnValue = true;\n    }\n    return returnValue;\n  };\n\n  // Runs if only specific files are accepted\n  if (acceptedFilesAttr) {\n    const acceptedFiles = acceptedFilesAttr.split(\",\");\n    const errorMessage = document.createElement(\"div\");\n\n    // If multiple files are dragged, this iterates through them and look for any files that are not accepted.\n    let allFilesAllowed = true;\n    const scannedFiles = e.target.files || e.dataTransfer.files;\n    for (let i = 0; i < scannedFiles.length; i += 1) {\n      const file = scannedFiles[i];\n      if (allFilesAllowed) {\n        for (let j = 0; j < acceptedFiles.length; j += 1) {\n          const fileType = acceptedFiles[j];\n          allFilesAllowed =\n            file.name.indexOf(fileType) > 0 ||\n            isIncluded(file.type, fileType.replace(/\\*/g, \"\"));\n          if (allFilesAllowed) {\n            TYPE_IS_VALID = true;\n            break;\n          }\n        }\n      } else break;\n    }\n\n    // If dragged files are not accepted, this removes them from the value of the input and creates and error state\n    if (!allFilesAllowed) {\n      removeOldPreviews(dropTarget, instructions);\n      fileInputEl.value = \"\"; // eslint-disable-line no-param-reassign\n      dropTarget.insertBefore(errorMessage, fileInputEl);\n      errorMessage.textContent =\n        fileInputEl.dataset.errormessage || `This is not a valid file type.`;\n      errorMessage.classList.add(ACCEPTED_FILE_MESSAGE_CLASS);\n      dropTarget.classList.add(INVALID_FILE_CLASS);\n      TYPE_IS_VALID = false;\n      e.preventDefault();\n      e.stopPropagation();\n    }\n  }\n};\n\n/**\n * 1. passes through gate for preventing invalid files\n * 2. handles updates if file is valid\n * @param {event} event\n * @param {HTMLElement} element\n * @param {HTMLElement} instructionsEl\n * @param {HTMLElement} target\n */\nconst handleUpload = (event, element, instructionsEl, dropTargetEl) => {\n  preventInvalidFiles(event, element, instructionsEl, dropTargetEl);\n  if (TYPE_IS_VALID === true) {\n    handleChange(event, element, instructionsEl, dropTargetEl);\n  }\n};\n\nconst fileInput = behavior(\n  {},\n  {\n    init(root) {\n      selectOrMatches(DROPZONE, root).forEach((fileInputEl) => {\n        const { instructions, dropTarget } = buildFileInput(fileInputEl);\n\n        dropTarget.addEventListener(\n          \"dragover\",\n          function handleDragOver() {\n            this.classList.add(DRAG_CLASS);\n          },\n          false\n        );\n\n        dropTarget.addEventListener(\n          \"dragleave\",\n          function handleDragLeave() {\n            this.classList.remove(DRAG_CLASS);\n          },\n          false\n        );\n\n        dropTarget.addEventListener(\n          \"drop\",\n          function handleDrop() {\n            this.classList.remove(DRAG_CLASS);\n          },\n          false\n        );\n\n        fileInputEl.addEventListener(\n          \"change\",\n          (e) => handleUpload(e, fileInputEl, instructions, dropTarget),\n          false\n        );\n      });\n    },\n    teardown(root) {\n      selectOrMatches(INPUT, root).forEach((fileInputEl) => {\n        const fileInputTopElement = fileInputEl.parentElement.parentElement;\n        fileInputTopElement.parentElement.replaceChild(\n          fileInputEl,\n          fileInputTopElement\n        );\n        // eslint-disable-next-line no-param-reassign\n        fileInputEl.className = DROPZONE_CLASS;\n      });\n    },\n    getFileInputContext,\n    disable,\n    enable,\n  }\n);\n\nmodule.exports = fileInput;\n"],"names":[],"sourceRoot":""}